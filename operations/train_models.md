# モデルの訓練

※ 以下、 [ML](https://github.com/metaboatrace/ml) リポジトリで作業を行うものとする  
※ スクリプト実行時に `PYTHONPATH=.:$PYTHONPATH` が省略されている場合は、 `uv pip install -e .` が実行済みであること

## 前提条件

- `FeatureDataset` を生成済みであること

## 概要
モデルの訓練には、2つのアプローチが存在する

| 手法 | スクリプト | 概要 |
| --- | --- | --- |
| **ホールドアウト検証** | `train_model_holdout.py` | 全データのうち最後の1年をテストデータとして評価する方法 |
| **時系列交差検証** | `train_model_cv.py` | Expanding Window などの手法を用いて、時系列データに適した交差検証を行う方法 |

これらのスクリプトは**対話モード（Interactive Mode）のみ**をサポートしている。
実行すると、学習対象やパラメータを順次選択するプロンプトが表示される。

## 訓練モード

スクリプト実行時に、以下の2つのモードから選択できる。

| モード | 特徴 | 用途 |
| --- | --- | --- |
| **Basic Mode** | ・高速<br>・デフォルトのパラメータを使用<br>・アンダーサンプリングによる不均衡データ対策 | ・動作確認<br>・ベースライン作成<br>・Rankerモデルの訓練 |
| **Full Mode** | ・**Optunaによるハイパーパラメータ最適化**<br>・SMOTEによるオーバーサンプリング<br>・計算コストが高い（数十分〜数時間） | ・最終的なモデル構築<br>・精度向上<br>・コンペティション提出用 |

> [!NOTE]
> `Full Mode` は計算時間が長くなるため、`tm` (tmux) や `nohup` などを利用してバックグラウンドで実行することを推奨する。
> 特に `XGBoost` と `Full Mode` の組み合わせは非常に時間がかかる場合がある。

## 実行例

### ホールドアウト検証による訓練

#### 用途

- 基本的なモデルの性能確認
- 最終的なモデル構築

#### 実行手順

```bash
uv run scripts/train_model_holdout.py
```

実行後、ターゲット、データ形式、モデルタイプ、訓練モードなどを対話形式で選択する。

### 時系列交差検証による訓練

#### 用途

- モデルの汎化性能に対する厳密的な評価

#### 実行手順

```bash
uv run scripts/train_model_cv.py
```

実行後、ターゲット、使用する年、CV戦略（Expanding Window等）などを対話形式で選択する。
## 出力

訓練が完了すると、以下の成果物が生成される（スクリプトやオプションによる）

- **モデルファイル (`.pkl`)**: 学習済みモデル
- **メタデータ (`.json`)**: 学習時のパラメータや評価指標
- **評価レポート**: コンソールに出力される精度、F1スコア、重要度などのメトリクス

## 注意事項

- ranker系のモデル（`lightgbm_ranker` など）を使用する場合は、データ形式として `vertical` を選択する必要がある
- `full` モードは計算コストが高いため、大規模なデータセットで使用する場合は時間がかかることがある
